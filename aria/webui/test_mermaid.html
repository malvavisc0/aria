<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Integration Test</title>
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mermaid.css">
    <style>
        body {
            padding: 20px;
            font-family: 'Inter', system-ui, sans-serif;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }
        .test-description {
            margin-bottom: 15px;
            color: #4a5568;
        }
        .theme-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .error-log {
            background: #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success-log {
            background: #c6f6d5;
            color: #22543d;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body class="theme-light">
    <button class="theme-toggle-btn" onclick="toggleTheme()">Toggle Theme</button>
    
    <h1>Mermaid Integration Test Suite</h1>
    <p>This page tests various aspects of the mermaid rendering integration.</p>
    
    <div id="test-results"></div>
    
    <div class="test-section">
        <div class="test-title">Test 1: Basic Flowchart</div>
        <div class="test-description">Simple flowchart to test basic rendering</div>
        <div class="mermaid">
graph TD
    A[Start] --> B{Is it working?}
    B -->|Yes| C[Great!]
    B -->|No| D[Debug]
    D --> B
        </div>
    </div>
    
    <div class="test-section">
        <div class="test-title">Test 2: Sequence Diagram</div>
        <div class="test-description">Sequence diagram with multiple participants</div>
        <div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant Database
    
    User->>Frontend: Send message
    Frontend->>Backend: API request
    Backend->>Database: Query data
    Database-->>Backend: Return results
    Backend-->>Frontend: JSON response
    Frontend-->>User: Display result
        </div>
    </div>
    
    <div class="test-section">
        <div class="test-title">Test 3: Class Diagram</div>
        <div class="test-description">Class diagram with relationships</div>
        <div class="mermaid">
classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +boolean indoor
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat
        </div>
    </div>
    
    <div class="test-section">
        <div class="test-title">Test 4: State Diagram</div>
        <div class="test-description">State diagram for user authentication</div>
        <div class="mermaid">
stateDiagram-v2
    [*] --> Idle
    Idle --> Authenticating : login
    Authenticating --> Authenticated : success
    Authenticating --> Idle : failure
    Authenticated --> Idle : logout
    Authenticated --> [*]
        </div>
    </div>
    
    <div class="test-section">
        <div class="test-title">Test 5: Gantt Chart</div>
        <div class="test-description">Project timeline visualization</div>
        <div class="mermaid">
gantt
    title Development Timeline
    dateFormat  YYYY-MM-DD
    section Planning
    Requirements    :done, req, 2024-01-01, 2024-01-15
    Design         :done, design, after req, 10d
    section Development
    Frontend       :active, frontend, 2024-01-20, 20d
    Backend        :backend, after frontend, 15d
    Testing        :testing, after backend, 10d
        </div>
    </div>
    
    <div class="test-section">
        <div class="test-title">Test 6: Error Handling</div>
        <div class="test-description">Invalid syntax to test error handling</div>
        <div class="mermaid">
invalid mermaid syntax
this should trigger error handling
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.7.0/dist/mermaid.min.js"></script>
    <script type="module">
        import { renderMermaidDiagrams } from './js/mermaid_fix.js';
        
        let currentTheme = 'light';
        let testResults = [];
        
        // Theme toggle functionality
        window.toggleTheme = function() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.className = `theme-${currentTheme}`;
            
            // Re-initialize mermaid with new theme
            if (window.mermaid) {
                window.mermaid.initialize({
                    theme: currentTheme === 'dark' ? 'dark' : 'default',
                    startOnLoad: false,
                    fontFamily: 'Inter, system-ui, sans-serif',
                    fontSize: 14,
                    securityLevel: 'loose',
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true
                    },
                    sequence: {
                        useMaxWidth: true,
                        wrap: true
                    }
                });
                
                // Re-render all diagrams
                renderAllDiagrams();
            }
        };
        
        // Test runner
        async function runTests() {
            const resultsDiv = document.getElementById('test-results');
            testResults = [];
            
            // Test 1: Library availability
            addTestResult('Library Availability', window.mermaid ? 'PASS' : 'FAIL', 
                window.mermaid ? 'Mermaid library loaded successfully' : 'Mermaid library not found');
            
            // Test 2: Markdown-it availability
            addTestResult('Markdown-it Availability', window.markdownit ? 'PASS' : 'FAIL',
                window.markdownit ? 'Markdown-it library loaded successfully' : 'Markdown-it library not found');
            
            // Test 3: Render all diagrams
            try {
                await renderAllDiagrams();
                addTestResult('Diagram Rendering', 'PASS', 'All diagrams rendered without throwing errors');
            } catch (error) {
                addTestResult('Diagram Rendering', 'FAIL', `Error: ${error.message}`);
            }
            
            // Test 4: SVG generation
            const svgElements = document.querySelectorAll('.mermaid svg');
            addTestResult('SVG Generation', svgElements.length > 0 ? 'PASS' : 'FAIL',
                `Generated ${svgElements.length} SVG elements`);
            
            // Test 5: Visibility check
            let visibleCount = 0;
            svgElements.forEach(svg => {
                if (svg.offsetHeight > 0 && svg.offsetWidth > 0) {
                    visibleCount++;
                }
            });
            addTestResult('SVG Visibility', visibleCount > 0 ? 'PASS' : 'FAIL',
                `${visibleCount} out of ${svgElements.length} SVGs are visible`);
            
            // Display results
            displayTestResults(resultsDiv);
        }
        
        function addTestResult(testName, status, message) {
            testResults.push({ testName, status, message, timestamp: new Date() });
        }
        
        function displayTestResults(container) {
            const html = testResults.map(result => `
                <div class="${result.status === 'PASS' ? 'success-log' : 'error-log'}">
                    <strong>${result.testName}:</strong> ${result.status}<br>
                    ${result.message}<br>
                    <small>${result.timestamp.toLocaleTimeString()}</small>
                </div>
            `).join('');
            
            container.innerHTML = `
                <h2>Test Results</h2>
                ${html}
                <button onclick="location.reload()" style="margin-top: 15px; padding: 8px 16px; background: #4299e1; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Run Tests Again
                </button>
            `;
        }
        
        async function renderAllDiagrams() {
            const containers = document.querySelectorAll('.test-section');
            for (const container of containers) {
                await renderMermaidDiagrams(container);
            }
        }
        
        // Wait for libraries to load, then run tests
        function waitForLibraries() {
            if (window.mermaid && window.markdownit) {
                console.log('✅ All libraries loaded, running tests...');
                runTests();
            } else {
                console.log('⏳ Waiting for libraries to load...');
                setTimeout(waitForLibraries, 100);
            }
        }
        
        // Start the test process
        waitForLibraries();
        
        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            addTestResult('Global Error', 'FAIL', `${e.error.message} at ${e.filename}:${e.lineno}`);
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            addTestResult('Promise Rejection', 'FAIL', e.reason.message || e.reason);
        });
    </script>
</body>
</html>